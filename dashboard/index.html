---
layout: default
title: Review Dashboard
---

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Review Dashboard</h1>
    <p>Track your submissions and download review reports</p>
  </div>

  <!-- Login Required -->
  <div id="login-required" class="login-required">
    <div class="login-box">
      <h2>Sign In Required</h2>
      <p>Please sign in to view your submissions and reviews.</p>
      <a href="/agentic-journal/portal/" class="btn btn-primary">Go to Portal</a>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard-content" style="display: none;">
    <div class="user-bar">
      <div class="user-info">
        <img id="user-avatar" src="" alt="Avatar" class="avatar">
        <span id="user-name"></span>
      </div>
      <div class="dashboard-actions">
        <a href="/agentic-journal/portal/" class="btn btn-primary">New Submission</a>
        <button id="logout-btn" class="btn btn-small">Sign Out</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-submissions">0</div>
        <div class="stat-label">Total Submissions</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-reviews">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-reviews">0</div>
        <div class="stat-label">Completed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="accepted-papers">0</div>
        <div class="stat-label">Accepted</div>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="submissions-section">
      <h2>Your Submissions</h2>

      <div class="filter-bar">
        <select id="status-filter">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="in_review">In Review</option>
          <option value="completed">Completed</option>
        </select>
        <input type="text" id="search-input" placeholder="Search submissions...">
      </div>

      <div id="submissions-list" class="submissions-list">
        <div class="loading">Loading submissions...</div>
      </div>

      <div id="no-submissions" class="no-submissions" style="display: none;">
        <p>No submissions yet.</p>
        <a href="/agentic-journal/portal/" class="btn btn-primary">Submit Your First Paper</a>
      </div>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div id="review-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <div id="modal-body">
      <!-- Review content loaded here -->
    </div>
  </div>
</div>

<style>
.dashboard-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.dashboard-header {
  text-align: center;
  margin-bottom: 2rem;
}

.dashboard-header h1 {
  color: var(--primary-color);
}

.login-required {
  text-align: center;
  padding: 4rem;
}

.login-box {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 3rem;
  max-width: 400px;
  margin: 0 auto;
}

.user-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 2rem;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.dashboard-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
}

.stat-number {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--primary-color);
}

.stat-label {
  color: #666;
  font-size: 0.9rem;
}

.submissions-section {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 1.5rem;
}

.submissions-section h2 {
  margin-bottom: 1rem;
  color: var(--primary-color);
}

.filter-bar {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.filter-bar select,
.filter-bar input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 6px;
}

.filter-bar input {
  flex: 1;
}

.submissions-list {
  min-height: 200px;
}

.submission-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  transition: box-shadow 0.2s;
}

.submission-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.submission-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}

.submission-title {
  font-weight: 600;
  color: #333;
  font-size: 1.1rem;
}

.submission-status {
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-in_review {
  background: #cce5ff;
  color: #004085;
}

.status-completed {
  background: #d4edda;
  color: #155724;
}

.status-accepted {
  background: #28a745;
  color: white;
}

.status-rejected {
  background: #f8d7da;
  color: #721c24;
}

.status-revision {
  background: #e2e3e5;
  color: #383d41;
}

.submission-meta {
  color: #666;
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
}

.submission-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  text-decoration: none;
  display: inline-block;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-small {
  padding: 0.25rem 0.75rem;
  font-size: 0.85rem;
  background: #eee;
}

.btn-download {
  background: #17a2b8;
  color: white;
}

.no-submissions {
  text-align: center;
  padding: 3rem;
  color: #666;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: #666;
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 12px;
  max-width: 900px;
  max-height: 90vh;
  width: 90%;
  overflow-y: auto;
  position: relative;
}

.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  font-size: 1.5rem;
  cursor: pointer;
  color: #666;
}

.modal-close:hover {
  color: #333;
}

#modal-body {
  padding: 2rem;
}

/* Review Report Styles */
.review-report {
  font-family: inherit;
}

.review-report h2 {
  color: var(--primary-color);
  border-bottom: 2px solid var(--primary-color);
  padding-bottom: 0.5rem;
}

.review-report h3 {
  color: #333;
  margin-top: 1.5rem;
}

.score-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.score-item {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
}

.score-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary-color);
}

.score-label {
  font-size: 0.85rem;
  color: #666;
}

.decision-badge {
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: bold;
  margin: 1rem 0;
}

.decision-accept { background: #d4edda; color: #155724; }
.decision-minor_revision { background: #fff3cd; color: #856404; }
.decision-major_revision { background: #f8d7da; color: #721c24; }
.decision-reject { background: #dc3545; color: white; }

.action-items {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
}

.action-item {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.priority-required { color: #dc3545; font-weight: bold; }
.priority-recommended { color: #fd7e14; }
.priority-suggested { color: #6c757d; }

@media (max-width: 768px) {
  .user-bar {
    flex-direction: column;
    gap: 1rem;
  }

  .filter-bar {
    flex-direction: column;
  }

  .submission-header {
    flex-direction: column;
    gap: 0.5rem;
  }
}
</style>

<script>
const REPO_OWNER = 'akz4ol';
const REPO_NAME = 'agentic-journal';

document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('github_token');
  const user = JSON.parse(localStorage.getItem('github_user') || 'null');

  if (token && user) {
    showDashboard(user, token);
  }

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', function() {
    localStorage.removeItem('github_token');
    localStorage.removeItem('github_user');
    location.reload();
  });

  // Modal close
  document.querySelector('.modal-close')?.addEventListener('click', function() {
    document.getElementById('review-modal').style.display = 'none';
  });

  // Filter and search
  document.getElementById('status-filter')?.addEventListener('change', filterSubmissions);
  document.getElementById('search-input')?.addEventListener('input', filterSubmissions);
});

async function showDashboard(user, token) {
  document.getElementById('login-required').style.display = 'none';
  document.getElementById('dashboard-content').style.display = 'block';
  document.getElementById('user-avatar').src = user.avatar_url;
  document.getElementById('user-name').textContent = user.login;

  await loadSubmissions(token);
}

async function loadSubmissions(token) {
  const listContainer = document.getElementById('submissions-list');

  try {
    // Fetch issues (submissions) from GitHub
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues?labels=submission&state=all&per_page=100`,
      {
        headers: { 'Authorization': `token ${token}` }
      }
    );

    if (!response.ok) throw new Error('Failed to fetch submissions');

    const issues = await response.json();

    // Also get local submissions
    const localSubmissions = JSON.parse(localStorage.getItem('submissions') || '[]');

    // Combine and deduplicate
    const submissions = processSubmissions(issues, localSubmissions);

    if (submissions.length === 0) {
      listContainer.style.display = 'none';
      document.getElementById('no-submissions').style.display = 'block';
      return;
    }

    // Update stats
    updateStats(submissions);

    // Render submissions
    renderSubmissions(submissions, token);

  } catch (error) {
    console.error('Error loading submissions:', error);
    listContainer.innerHTML = `<p class="error">Error loading submissions. Please try again.</p>`;
  }
}

function processSubmissions(issues, localSubmissions) {
  const submissions = [];

  for (const issue of issues) {
    // Extract submission ID from title
    const match = issue.body?.match(/\*\*Submission ID:\*\* ([\w-]+)/);
    const submissionId = match ? match[1] : `ISSUE-${issue.number}`;

    // Determine status from labels
    let status = 'pending';
    const labels = issue.labels.map(l => l.name);

    if (labels.includes('accepted')) status = 'accepted';
    else if (labels.includes('rejected')) status = 'rejected';
    else if (labels.includes('revision')) status = 'revision';
    else if (labels.includes('completed')) status = 'completed';
    else if (labels.includes('in-review')) status = 'in_review';

    submissions.push({
      id: submissionId,
      issue_number: issue.number,
      title: issue.title.replace('[Submission] ', ''),
      status,
      created_at: issue.created_at,
      labels
    });
  }

  return submissions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
}

function updateStats(submissions) {
  document.getElementById('total-submissions').textContent = submissions.length;
  document.getElementById('pending-reviews').textContent =
    submissions.filter(s => ['pending', 'in_review'].includes(s.status)).length;
  document.getElementById('completed-reviews').textContent =
    submissions.filter(s => ['completed', 'accepted', 'rejected', 'revision'].includes(s.status)).length;
  document.getElementById('accepted-papers').textContent =
    submissions.filter(s => s.status === 'accepted').length;
}

function renderSubmissions(submissions, token) {
  const container = document.getElementById('submissions-list');
  window.allSubmissions = submissions;
  window.authToken = token;

  container.innerHTML = submissions.map(sub => `
    <div class="submission-card" data-status="${sub.status}" data-title="${sub.title.toLowerCase()}">
      <div class="submission-header">
        <div class="submission-title">${sub.title}</div>
        <span class="submission-status status-${sub.status}">${formatStatus(sub.status)}</span>
      </div>
      <div class="submission-meta">
        <strong>ID:</strong> ${sub.id} |
        <strong>Submitted:</strong> ${new Date(sub.created_at).toLocaleDateString()}
      </div>
      <div class="submission-actions">
        ${['completed', 'accepted', 'rejected', 'revision'].includes(sub.status) ? `
          <button class="btn btn-primary" onclick="viewReview('${sub.id}')">View Review</button>
          <button class="btn btn-download" onclick="downloadReport('${sub.id}')">Download PDF</button>
        ` : `
          <span style="color: #666; font-style: italic;">Review in progress...</span>
        `}
      </div>
    </div>
  `).join('');
}

function formatStatus(status) {
  const statusMap = {
    'pending': 'Pending',
    'in_review': 'In Review',
    'completed': 'Completed',
    'accepted': 'Accepted',
    'rejected': 'Rejected',
    'revision': 'Revision Needed'
  };
  return statusMap[status] || status;
}

function filterSubmissions() {
  const statusFilter = document.getElementById('status-filter').value;
  const searchTerm = document.getElementById('search-input').value.toLowerCase();

  document.querySelectorAll('.submission-card').forEach(card => {
    const status = card.dataset.status;
    const title = card.dataset.title;

    const matchesStatus = statusFilter === 'all' || status === statusFilter;
    const matchesSearch = title.includes(searchTerm);

    card.style.display = matchesStatus && matchesSearch ? 'block' : 'none';
  });
}

async function viewReview(submissionId) {
  const modal = document.getElementById('review-modal');
  const modalBody = document.getElementById('modal-body');

  modal.style.display = 'flex';
  modalBody.innerHTML = '<div class="loading">Loading review...</div>';

  try {
    // Fetch review from GitHub
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/reviews/${submissionId}/meta-review.yaml`,
      {
        headers: { 'Authorization': `token ${window.authToken}` }
      }
    );

    if (!response.ok) {
      throw new Error('Review not found');
    }

    const data = await response.json();
    const content = atob(data.content);
    const review = jsyaml.load(content);

    modalBody.innerHTML = renderReviewReport(submissionId, review);

  } catch (error) {
    modalBody.innerHTML = `
      <h2>Review Not Available</h2>
      <p>The review for this submission is not yet available or could not be loaded.</p>
      <p>Error: ${error.message}</p>
    `;
  }
}

function renderReviewReport(submissionId, review) {
  const decision = review.decision || 'pending';
  const synthesis = review.synthesis || {};

  return `
    <div class="review-report">
      <h2>Review Report</h2>
      <p><strong>Submission ID:</strong> ${submissionId}</p>

      <div class="decision-badge decision-${decision}">
        Decision: ${decision.toUpperCase().replace('_', ' ')}
      </div>

      <h3>Score Summary</h3>
      <div class="score-grid">
        <div class="score-item">
          <div class="score-value">${synthesis.weighted_average?.toFixed(1) || 'N/A'}</div>
          <div class="score-label">Overall Score</div>
        </div>
        ${Object.entries(synthesis.score_breakdown || {}).map(([agent, score]) => `
          <div class="score-item">
            <div class="score-value">${score?.toFixed(1) || 'N/A'}</div>
            <div class="score-label">${agent.charAt(0).toUpperCase() + agent.slice(1)}</div>
          </div>
        `).join('')}
      </div>

      <h3>Decision Rationale</h3>
      <p>${review.rationale || 'No rationale provided.'}</p>

      ${review.author_action_items?.length ? `
        <h3>Action Items</h3>
        <div class="action-items">
          ${review.author_action_items.map(item => `
            <div class="action-item">
              <span class="priority-${item.priority}">[${item.priority}]</span>
              <span>${item.action}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${synthesis.consensus_strengths?.length ? `
        <h3>Strengths</h3>
        <ul>
          ${synthesis.consensus_strengths.map(s => `<li>${s}</li>`).join('')}
        </ul>
      ` : ''}

      ${synthesis.consensus_concerns?.length ? `
        <h3>Concerns</h3>
        <ul>
          ${synthesis.consensus_concerns.map(c => `<li>${c}</li>`).join('')}
        </ul>
      ` : ''}

      ${review.revision_guidance ? `
        <h3>Revision Guidance</h3>
        <p>${review.revision_guidance}</p>
      ` : ''}

      <div style="margin-top: 2rem; text-align: center;">
        <button class="btn btn-download" onclick="downloadReport('${submissionId}')">
          Download Full Report (PDF)
        </button>
      </div>
    </div>
  `;
}

async function downloadReport(submissionId) {
  // Generate PDF report
  const reportWindow = window.open('', '_blank');
  reportWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Review Report - ${submissionId}</title>
      <style>
        body { font-family: Georgia, serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
        h1 { color: #1a365d; border-bottom: 2px solid #1a365d; }
        h2 { color: #2d3748; margin-top: 2rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .score-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .score-table th, .score-table td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
        .score-table th { background: #f8f9fa; }
        .decision { font-size: 1.5rem; font-weight: bold; padding: 1rem; text-align: center; margin: 1rem 0; }
        .accept { background: #d4edda; color: #155724; }
        .minor_revision { background: #fff3cd; color: #856404; }
        .major_revision { background: #f8d7da; color: #721c24; }
        .reject { background: #dc3545; color: white; }
        .footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ddd; font-size: 0.9rem; color: #666; }
        @media print { body { padding: 0; } }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Agentic Journal</h1>
        <h2>Peer Review Report</h2>
        <p>Submission ID: ${submissionId}</p>
        <p>Generated: ${new Date().toLocaleDateString()}</p>
      </div>
      <p>Loading review data...</p>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"><\/script>
    </body>
    </html>
  `);

  // Fetch and render review
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/reviews/${submissionId}/meta-review.yaml`,
      {
        headers: { 'Authorization': `token ${window.authToken}` }
      }
    );

    const data = await response.json();
    const content = atob(data.content);

    reportWindow.document.body.innerHTML = generatePDFReport(submissionId, content);

    // Trigger print dialog
    setTimeout(() => reportWindow.print(), 500);

  } catch (error) {
    reportWindow.document.body.innerHTML = `<h1>Error</h1><p>Could not load review: ${error.message}</p>`;
  }
}

function generatePDFReport(submissionId, yamlContent) {
  // Parse YAML in the new window context
  return `
    <div class="header">
      <h1>Agentic Journal</h1>
      <h2>Peer Review Report</h2>
      <p><strong>Submission ID:</strong> ${submissionId}</p>
      <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"><\/script>
    <script>
      const review = jsyaml.load(\`${yamlContent.replace(/`/g, '\\`')}\`);
      const synthesis = review.synthesis || {};

      document.body.innerHTML += \`
        <div class="decision \${review.decision}">
          Decision: \${review.decision?.toUpperCase().replace('_', ' ') || 'PENDING'}
        </div>

        <h2>Score Summary</h2>
        <table class="score-table">
          <tr><th>Reviewer</th><th>Score</th></tr>
          <tr><td>Technical</td><td>\${synthesis.score_breakdown?.technical?.toFixed(1) || 'N/A'}</td></tr>
          <tr><td>Domain</td><td>\${synthesis.score_breakdown?.domain?.toFixed(1) || 'N/A'}</td></tr>
          <tr><td>Ethics</td><td>\${synthesis.score_breakdown?.ethics?.toFixed(1) || 'N/A'}</td></tr>
          <tr><td>Clarity</td><td>\${synthesis.score_breakdown?.clarity?.toFixed(1) || 'N/A'}</td></tr>
          <tr><th>Weighted Average</th><th>\${synthesis.weighted_average?.toFixed(1) || 'N/A'}</th></tr>
        </table>

        <h2>Decision Rationale</h2>
        <p>\${review.rationale || 'No rationale provided.'}</p>

        \${review.author_action_items?.length ? \`
          <h2>Required Actions</h2>
          <ul>
            \${review.author_action_items.map(item => \`<li><strong>[\${item.priority}]</strong> \${item.action}</li>\`).join('')}
          </ul>
        \` : ''}

        \${synthesis.consensus_strengths?.length ? \`
          <h2>Strengths</h2>
          <ul>\${synthesis.consensus_strengths.map(s => \`<li>\${s}</li>\`).join('')}</ul>
        \` : ''}

        \${synthesis.consensus_concerns?.length ? \`
          <h2>Areas for Improvement</h2>
          <ul>\${synthesis.consensus_concerns.map(c => \`<li>\${c}</li>\`).join('')}</ul>
        \` : ''}

        \${review.revision_guidance ? \`
          <h2>Revision Guidance</h2>
          <p>\${review.revision_guidance}</p>
        \` : ''}

        <div class="footer">
          <p>This review was generated by the Agentic Journal multi-agent peer review system.</p>
          <p>Reviews are AI-generated and should be evaluated critically.</p>
          <p>For more information, visit: https://akz4ol.github.io/agentic-journal/</p>
        </div>
      \`;
    <\/script>
  `;
}
</script>

<!-- Include js-yaml for YAML parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
