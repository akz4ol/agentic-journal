---
layout: default
title: Authenticating...
---

<div class="callback-container">
  <div class="spinner"></div>
  <p id="status-text">Authenticating with GitHub...</p>
</div>

<style>
.callback-container {
  text-align: center;
  padding: 4rem;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary-color);
  border-radius: 50%;
  margin: 0 auto 1rem;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-box {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
}

.btn {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  background: var(--primary-color);
  color: white;
  text-decoration: none;
  border-radius: 6px;
  margin-top: 1rem;
}
</style>

<script>
// OAuth token exchange worker URL
// Deploy the worker from docs/oauth-worker.js and update this URL
const OAUTH_WORKER_URL = 'https://agentic-journal-oauth.YOUR-SUBDOMAIN.workers.dev';

document.addEventListener('DOMContentLoaded', async function() {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const container = document.querySelector('.callback-container');
  const statusText = document.getElementById('status-text');

  if (code) {
    try {
      statusText.textContent = 'Exchanging authorization code...';

      // Check if worker is configured
      if (OAUTH_WORKER_URL.includes('YOUR-SUBDOMAIN')) {
        // Worker not configured - show setup instructions
        container.innerHTML = `
          <h2>OAuth Setup Required</h2>
          <p>To complete GitHub authentication, deploy the OAuth worker:</p>
          <ol style="text-align: left; max-width: 500px; margin: 1rem auto;">
            <li>Go to <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a></li>
            <li>Create a new Worker</li>
            <li>Copy code from <code>docs/oauth-worker.js</code></li>
            <li>Add secret: <code>GITHUB_CLIENT_SECRET</code></li>
            <li>Deploy and update <code>OAUTH_WORKER_URL</code> in callback.html</li>
          </ol>
          <a href="/agentic-journal/portal/" class="btn">Return to Portal</a>
        `;
        return;
      }

      // Exchange code for token via worker
      const response = await fetch(OAUTH_WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      // Store token and user
      localStorage.setItem('github_token', data.access_token);
      localStorage.setItem('github_user', JSON.stringify(data.user));

      statusText.textContent = 'Success! Redirecting...';

      // Redirect to portal
      setTimeout(() => {
        window.location.href = '/agentic-journal/portal/';
      }, 500);

    } catch (error) {
      console.error('Auth error:', error);
      container.innerHTML = `
        <h2>Authentication Failed</h2>
        <div class="error-box">${error.message}</div>
        <a href="/agentic-journal/portal/" class="btn">Try Again</a>
      `;
    }
  } else {
    // No code - redirect to portal
    window.location.href = '/agentic-journal/portal/';
  }
});
</script>
